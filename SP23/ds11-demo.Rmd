---
title: "Discussion 11 - Demo"
author: "Cameron Jones"
date: "Week of April 24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggrepel) # you may have to install ggrepel on your machine with install.packages("ggrepel")
library(ggtext) # you may have to install ggtext on your machine with install.packages("ggtext")
```

# Concept Review

##### Data: Star Wars Characters

We are interested in predicting the mass (kg) of the star wars characters using their height (cm). Note that these are two continuous numeric outcomes; other types of variables have analogous forms of regression covered in other classes (or come talk to me!)

```{r}
head(starwars[,c("name", "height", "mass")])
```

```{r, warning = FALSE, fig.height = 5, fig.width = 7}
# geom_text_repel is a "smart" point labeler from the ggrepel library

ggplot(starwars, aes(x = height, y = mass, label = name)) + geom_point() + geom_text_repel()
```

### Linear Regression

We assume that the heights of the star wars characters are generated by some random linear process based on their mass. Let $Y_i$ represent the ith character's weight, and let $X_i$ represent the $i$th's character's height. $\beta_0 + \beta_1*X_i$ is the "y = mx + b" form of the line, and $\epsilon_i$ is the random distance from the line for each point (more on that below). 

**Model**

$$
Y_i = \beta_0 + \beta_1 *X_i + \epsilon_i
$$

*Key assumptions*

- We assume that $Y_i$ is a LINEAR function of $X_i$ rather than some polynomial fit.
- We assume that $\epsilon_i$'s are independent. One character's deviation from the line doesn't affect another's.
- We assume that $\epsilon_i$'s follow the $Normal(0, \sigma^2)$ distribution. The zero represents the fact that on average, heights are generated right on the best fit line. We do not know the true variance $\sigma^2$, but crucially it is constant and does not vary with $X$.

**Hypotheses**

We want to show that the random process which generates character's heights depends on mass in some capacity. In other words, having a character's mass allows us to make a better than random guess at their height. Mathematically:

$$
H_0: \beta_1 = 0
$$

$$
H_A: \beta_1 \neq 0
$$

**Inference**

Using theory, inference on $\beta_1$ is more involved and is gone over in detail in lecture. However, the framework is similar to the t-test in that under the null hypothesis, the estimated $\hat{\beta_1}/SE(\hat{\beta_1})$ should follow a $t(n-2)$ distribution, and p-values are calculated from this fact.

The command ```lm(outcome ~ input1 + input2 + ..., data)``` does all this for you, and inference results can be extracted by running ```summary()``` on the model object.

```{r}
model = lm(height ~ mass, starwars)

# running just summary(model) gives you a ton of information, I reduce it to just the relevant info with $coefficients
summary(model)$coefficients
```
```{r}
# The algebraic forms of these values are covered in lecture, they are complex
estimate = 0.02807
se = 0.02752
n = 59 # you can check this with starwars %>% drop_na(height, mass) %>% count()

# But, using them, we can recreate the t-value and p-value from lm
(t_value = estimate/se)
(p_value = 2*(1-pt(t_value, df = n-2)))
```

The p-value of this test is 0.312. We fail to find evidence that the height of Star Wars characters is related to their mass.

This should make you go... really?

### Outliers and Their Importance

Remember the scatter plot at the beginning of this file? Jabba the Hutt, a large outlier, has an extreme effect on our linear model!

```{r, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 7, echo = FALSE}
ggplot(starwars %>% filter(!str_detect(name, "Jabba")), aes(x = height, y = mass, label = name)) +
  geom_point() + 
  geom_text_repel() + 
  geom_smooth(data = starwars, method = "lm", se = F, color = "#EF0107") + # Uses full starwars dataset
  geom_smooth(method = "lm", se = F, color = "#6CABDD") + # Uses default from ggplot() call at top, without Jabba
  
  ggtitle("Linear Regression <span style='color: #EF0107;'>With</span> and <span style='color: #6CABDD;'>Without</span> Jabba the Hutt") +
  theme(plot.title = element_markdown())
```

Notice that Jabba's inclusion drags the line far from that central cluster of points, making the linear model a much worse fit for the data. Conversely, removing him allows the model to be a great fit for the data.

Re-running the linear model without Jabba the Hutt,

```{r}
summary(lm(height ~ mass, starwars %>% filter(!str_detect(name, "Jabba"))))$coefficients
```

We find extremely strong evidence that among non-Jabba Star Wars characters, mass is a positive predictor of height.


